<!-- Muestra el componente de la ruta actual. Si NO está logueado, mostrará el LoginComponent. -->
<router-outlet *ngIf="!isLoggedIn"></router-outlet>

<!-- Este contenedor se muestra SOLAMENTE si el usuario está logueado (role=admin o role=worker) -->
<div *ngIf="isLoggedIn" class="app-container">

    <!-- BARRA SUPERIOR Y BOTÓN DE SALIR -->
    <div class="top-bar-logout">
        <button mat-flat-button color="warn" (click)="logout()">
            <mat-icon>logout</mat-icon>
            Salir
        </button>
    </div>
    
    <!-- ---------------------------------------------------- -->
    <!-- VISTA DEL ADMINISTRADOR (KANBAN) -->
    <!-- ---------------------------------------------------- -->
    <div *ngIf="userRole === 'admin'" class="page-wrapper">

        <h1 class="kanban-title">MAKRO - Gestión Administrativa</h1>

        <!-- FORMULARIO DE CREACIÓN DE TAREAS -->
        <mat-card class="task-form-card">
            <mat-card-title>Crear Nueva Tarea</mat-card-title>
            <mat-card-content>
                <form [formGroup]="taskForm" (ngSubmit)="addTask()" class="form-grid">
                    <mat-form-field appearance="outline" class="col-span-full">
                        <mat-label>Título de la Tarea</mat-label>
                        <input matInput formControlName="title">
                        <mat-error *ngIf="taskForm.get('title')?.invalid">Título es requerido</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="col-span-full">
                        <mat-label>Descripción</mat-label>
                        <textarea matInput formControlName="description" rows="2"></textarea>
                        <mat-error *ngIf="taskForm.get('description')?.invalid">Descripción es requerida</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Área</mat-label>
                        <mat-select formControlName="area">
                            <mat-option *ngFor="let area of availableAreas" [value]="area">
                                {{ area }}
                            </mat-option>
                        </mat-select>
                        <mat-error *ngIf="taskForm.get('area')?.invalid">Área requerida</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Prioridad</mat-label>
                        <mat-select formControlName="priority">
                            <mat-option *ngFor="let priority of availablePriorities" [value]="priority">
                                {{ priority }}
                            </mat-option>
                        </mat-select>
                        <mat-error *ngIf="taskForm.get('priority')?.invalid">Prioridad requerida</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Fecha Límite</mat-label>
                        <input matInput [matDatepicker]="picker" formControlName="dueDate" [min]="minDate">
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                        <mat-error *ngIf="taskForm.get('dueDate')?.invalid">Fecha límite requerida</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Pago Estimado ($)</mat-label>
                        <input matInput type="number" formControlName="estimatedPay">
                        <mat-error *ngIf="taskForm.get('estimatedPay')?.invalid">Pago requerido y positivo</mat-error>
                    </mat-form-field>

                    <button mat-raised-button color="primary" type="submit" [disabled]="!taskForm.valid" class="col-span-full add-task-button">
                        <mat-icon>add_circle</mat-icon>
                        Asignar Tarea
                    </button>
                </form>
            </mat-card-content>
        </mat-card>

        <!-- TABLERO KANBAN POR ÁREA Y PRIORIDAD -->
        <div class="kanban-board">
            
            <div *ngFor="let area of availableAreas" class="kanban-area">
                <h2>{{ area }}</h2>
                
                <div class="kanban-priorities">
                    
                    <div *ngFor="let priority of availablePriorities" class="kanban-column">
                        <h3 class="priority-title" [ngClass]="priority.toLowerCase()">{{ priority }}</h3>
                        
                        <div 
                            cdkDropList
                            [id]="getContainerNameByList(area, priority)"
                            [cdkDropListData]="(area === 'INGENIERÍA' && priority === 'Alta') ? ingenieriaAlta :
                                            (area === 'INGENIERÍA' && priority === 'Media') ? ingenieriaMedia :
                                            (area === 'INGENIERÍA' && priority === 'Baja') ? ingenieriaBaja :
                                            (area === 'LOGÍSTICA' && priority === 'Alta') ? logisticaAlta :
                                            (area === 'LOGÍSTICA' && priority === 'Media') ? logisticaMedia :
                                            (area === 'LOGÍSTICA' && priority === 'Baja') ? logisticaBaja :
                                            (area === 'MARKETING' && priority === 'Alta') ? marketingAlta :
                                            (area === 'MARKETING' && priority === 'Media') ? marketingMedia :
                                            (area === 'MARKETING' && priority === 'Baja') ? marketingBaja : []"
                            class="task-list" 
                            (cdkDropListDropped)="onDrop($event)">
                            
                            <mat-card *ngFor="let task of (area === 'INGENIERÍA' && priority === 'Alta') ? ingenieriaAlta :
                                                    (area === 'INGENIERÍA' && priority === 'Media') ? ingenieriaMedia :
                                                    (area === 'INGENIERÍA' && priority === 'Baja') ? ingenieriaBaja :
                                                    (area === 'LOGÍSTICA' && priority === 'Alta') ? logisticaAlta :
                                                    (area === 'LOGÍSTICA' && priority === 'Media') ? logisticaMedia :
                                                    (area === 'LOGÍSTICA' && priority === 'Baja') ? logisticaBaja :
                                                    (area === 'MARKETING' && priority === 'Alta') ? marketingAlta :
                                                    (area === 'MARKETING' && priority === 'Media') ? marketingMedia :
                                                    (area === 'MARKETING' && priority === 'Baja') ? marketingBaja : []" 
                                class="task-card" cdkDrag>

                                <div class="task-header">
                                    <mat-card-title>{{ task.title }}</mat-card-title>
                                    <button mat-icon-button color="warn" (click)="deleteTask(task, getContainerNameByList(area, priority))">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>
                                
                                <mat-card-subtitle>{{ area }} ({{ priority }})</mat-card-subtitle>
                                <p class="task-due-date">Límite: {{ task.dueDate | date }}</p>
                                <p class="task-pay">Pago: ${{ task.estimatedPay | number:'1.2-2' }}</p>
                                <p class="task-status status-{{ task.status }}">
                                    <mat-icon>{{ getStatusIcon(task.status) }}</mat-icon>
                                    {{ getStatusLabel(task.status) }}
                                </p>

                                <div class="task-placeholder" *cdkDragPlaceholder></div>
                            </mat-card>

                            <p *ngIf="(area === 'INGENIERÍA' && priority === 'Alta' && ingenieriaAlta.length === 0) ||
                                      (area === 'INGENIERÍA' && priority === 'Media' && ingenieriaMedia.length === 0) ||
                                      (area === 'INGENIERÍA' && priority === 'Baja' && ingenieriaBaja.length === 0) ||
                                      (area === 'LOGÍSTICA' && priority === 'Alta' && logisticaAlta.length === 0) ||
                                      (area === 'LOGÍSTICA' && priority === 'Media' && logisticaMedia.length === 0) ||
                                      (area === 'LOGÍSTICA' && priority === 'Baja' && logisticaBaja.length === 0) ||
                                      (area === 'MARKETING' && priority === 'Alta' && marketingAlta.length === 0) ||
                                      (area === 'MARKETING' && priority === 'Media' && marketingMedia.length === 0) ||
                                      (area === 'MARKETING' && priority === 'Baja' && marketingBaja.length === 0)" 
                                class="empty-list-message">
                                No hay tareas asignadas aquí.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- VISTA DEL TRABAJADOR (USER DASHBOARD) -->
    <!-- ---------------------------------------------------- -->
    <div *ngIf="userRole === 'worker'" class="user-view-wrapper">
        <app-user-dashboard 
            [userName]="userName"
            [userArea]="userArea"
            [tasks]="getUserTasks()"
            (taskStatusChanged)="onUserTaskStatusChanged($event)"
            (taskDetailsRequested)="onViewTaskDetails($event)">
        </app-user-dashboard>
    </div>
</div>